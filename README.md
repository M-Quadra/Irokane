# Irokane

移植torch模型时被CoreML各种报错与龟速推理难到了。

一开始在原始网络上强行修改，虽然性能感人，但好歹跑起来了。突发奇想要是coremltools能自动适配不用修改一键转换该多好，翻了下积攒的变更日志，看看哪些能挑出来推给上游，顺便水PR。

然后，有些op直接锁死CPU only，模型一旦降回CPU就回不去辣。麻了，如果最终锁死CPU，解决转换问题的等价替换纯属自欺欺人。MIL Ops文档完全没有op细节，还被Xcode 16预告会显示op无法加速原因给骗了，甚至有直接隐藏CPU only op的bug，血压暴涨。

好累，不想爱了。

> 不行，云老婆就是我所有的爱。

思来想去只能手动拆模型，CPU only部分使用MPS重写。

随缘开发，但愿后面有空测试下各方案的实践情况。

精神状态不佳，似有太监可能。



对于非固定shape，究竟是每步操作独立，降低单次计算图编译代价快？还是尽可能构建完整计算图编译后再执行快？

花时间把2条路都肝一遍？（肝不动，没时间。

x86 mac某些op运行有问题，不知后续是否会碰到更多。唉，想换arm mac。（钱包：不，你不想。



- Tenor

  实现类MLTensor即时获得编译结果。

  实现优先级低，有可能砍掉。`MLTensor`疑似`BNNS`包装，目前不觉得好用，缺失方法太多。单步调试不如二分注释效率高，没有编译优化让本就不多的算力更是紧张。

- Graph

  MPS计算图构建，先编译再推理。

  暂且使用MPS按照torch风格包装DSL，一些实现细节还未考虑好，先这样吧。

  `MPSTensorData`还是应该携带，传播远后回头捞输入反直觉。

- 名字没想好（针对coremltools的实现替换）

  类似速查手册，可能完全不实现。

  替换后也是一个一个一个CPU only，那不白替换了？



